<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Віраж ППО</title>
    <link rel="shortcut icon" href=".png" />
    <div class="template-container">
    </div>    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.1.0/leaflet-measure.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch/dist/geosearch.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch/dist/geosearch.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <script
    src="https://cdn.jsdelivr.net/gh/gokertanrisever/leaflet-ruler@master/src/leaflet-ruler.js"
    integrity="sha384-8SqKZR7V8uOetpjjbcNJHvwuHpb074WS0UXjCLhzfJUqYn3B/uWx1WVv5mwRp1mV"
    crossorigin="anonymous"
></script>
    <style>
        /* General Map Styles */
        #map {
            height: 100vh;
        }

        html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
}
#topbar {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background-color: #2d3240; /* синий */
    
    z-index: 1005;
}
#sidebar {
    position: absolute;
    top: 0;
    left: 0;
    width: 50px; /* Узкая боковая панель */
    height: 100%; /* На всю высоту экрана */
    background-color: #2d3240; /* Темный цвет для панели */
    z-index: 1000; /* Слои, чтобы быть выше карты */
}
.leaflet-control-layers {
  z-index: 2000;
  position: relative;
 zoom: 0.667;
  transform-origin: top left;
}

.modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    background: #252b36;
    padding: 13.3px 16px; /* 10px*1.333, 12px*1.333 */
    border-radius: 9.3px; /* 7px*1.333 */
    z-index: 1001;
    max-width: 240px; /* 180px*1.333 */
    width: 90%;
    transition: all 0.35s ease;
    color: #f0f0f0;
    font-family: 'Segoe UI', sans-serif;
    font-size: 9.3px; /* 7px*1.333 */
}

.modal h2 {
    font-size: 14.7px; /* 11px*1.333 */
    color: #ffffff;
    margin-bottom: 10.7px; /* 8px*1.333 */
    text-align: center;
}

input[type="text"] {
    width: 100%;
    padding: 5.3px 6.7px; /* 4px*1.333, 5px*1.333 */
    font-size: 9.3px; /* 7px*1.333 */
    background-color: #1e232c;
    color: #ffffff;
    border-radius: 5.3px; /* 4px*1.333 */
    border: 1.3px solid #3a4152; /* 1px*1.333 */
}

.modal-button {
    width: 100%;
    padding: 8px; /* 6px*1.333 */
    font-size: 10px; /* 7.5px*1.333 */
    margin-top: 13.3px; /* 10px*1.333 */
    background-color: #4674dc;
    color: white;
    border: none;
    border-radius: 5.3px; /* 4px*1.333 */
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
}

.modal-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(21, 24, 30, 0.85);
    z-index: 1000;
    display: none;
    backdrop-filter: blur(5.3px); /* 4px*1.333 */
}

.modal.show {
    display: block;
    transform: translate(-50%, -50%) scale(1);
}

:root {
    --map-tiles-filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.5) brightness(0.7) grayscale(3);
}

.map-tiles {
    filter: var(--map-tiles-filter, none);
}



.modal-button:hover {
    background-color: #6088e7;
}

.modal-button:focus {
    outline: none;
}

        /* Сдвигаем контейнер вправо для нужных объектов */
        .shifted-info-container {
            margin-left: 2.1px; /* Сдвиг на 20px вправо, можно менять значение */
        }
        .shifted-info-containerr {
            margin-right: 10px;
        }
    
    .red-id {
            color: #dd0347;
        }
        .blue-id {
            color: #006AFE; /* Синий цвет для текста */
        }

        /* Стили для текста в зависимости от цвета */
.red-id .label-container,
.red-id .r-container,
.red-id .rls-container, 
.red-id .icon-container {
    color: #dd0347;
}

.blue-id .label-container,
.blue-id .r-container,
.blue-id .rls-container,
.blue-id .icon-container {
        color: #006AFE; /* Синий цвет для текста */
}
      .shifted-id-x-101 {
    margin-left: 32px; /* 20 * 1.6 */
}
.shifted-id {
    margin-left: 24px; /* 15 * 1.6 */
}
.shifted-id-grumble,
.shifted-id-kinzhal {
    margin-left: 40px; /* 25 * 1.6 */
}

.info-container {
    line-height: 14px; /* 9 * 1.6 */
}
.iconname {
    line-height: 8px; /* 5 * 1.6 */
}
.info-container1 {
    line-height: 11px; /* 7 * 1.6 */
}
.info-container {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 1.7px; /* 2 * 0.83 */

    padding: 4px 33px 4px 33px; /* 5 → 4, 40 → 33 */
    min-width: 62px;            /* 75 * 0.83 */
    height: 9px;                /* 11 * 0.83 */
    line-height: 0.8;

    border-style: solid;
    border-width: 0.8px;        /* 1 * 0.83 */
    border-top-color: rgba(0,0,0,0.95);
    border-left-color: rgba(0,0,0,0.95);
    border-right-color: rgba(0,0,0,0.95);
    border-bottom-color: #dcdcdc;
    box-sizing: border-box;

    contain: layout paint;
    will-change: transform;
}

.info-container.expanded {
    display: flex !important;
    flex-direction: column !important;
    align-items: center;
    justify-content: center;
    gap: 0.8px;          /* 1 * 0.83 */
    padding: 2.5px 4px;  /* 3×5 → 2.5×4 */
    height: auto !important;
    min-width: auto;
    line-height: 1;
}

/* ——— Текстовые контейнеры ——— */
    .label-container,
    .r-container,
    .rls1-container,
    .rls-container,
    .label1-container,
    .r1-container {
        font-size: 8.6px;          /* 10.4 * 0.83 */
        font-weight: 800;
        font-family: 'Roboto', sans-serif;
        color: #333333;
        -webkit-text-stroke-color: black;
    }

.rls1-container,
.rls-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
}


   /* Delete Button */
#deleteButton {
    width: 24.6px;           /* 18.5 * 1.333 */
    height: 21.3px;          /* 16 * 1.333 */
    border-radius: 1.3px;    /* 1 * 1.333 */
    background-color: rgb(101, 101, 101);
    color: rgb(130, 130, 130);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    font-size: 10.7px;       /* 8 * 1.333 */
    box-shadow: 0 0.67px 2.67px rgba(0,0,0,0.3);  /* 0 0.5 2 * 1.333 */
    border: none;
    cursor: pointer;
}


        /* Smooth Transition for Modals */  
        .modal.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
.icon-container {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 7px;
    position: absolute;
    white-space: nowrap;
}
        .icon-container .icon {
            width: 26px;
            height: 26px;
            object-fit: cover;
            display: block;
        }
 .icon-wrap {
    position: relative;
    width: 26px;
    height: 26px;
}

/* линия под иконкой */
.icon-wrap::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 31.2px;           /* 26 × 1.2 */
    height: 1.2px;           /* 1 × 1.2 */
    background-color: rgb(0, 218, 0);
    border-radius: 1.2px;    /* 1 × 1.2 */
    transition: transform 0.15s ease-out;
}

/* когда маркер раскрыт */
.icon-wrap.expanded::after {
    transform: translateY(-6px); /* 5 × 1.2 */
}

/* если есть objectType */
.icon-wrap.expanded.with-type::after {
    transform: translateY(-12px); /* 10 × 1.2 */
}


.icon-container1 {
    display: flex;
    align-items: center;
    gap: 6.5px;   /* 13 / 2 */
    font-size: 7px; /* 14 / 2 */
    position: absolute;
    white-space: nowrap; /* Убираем перенос текста */
}
.icon-container1 .icon {
    width: 26px;   /* 34 / 2 */
    height: 26px;  /* 34 / 2 */
    object-fit: cover;
    display: block;
}
                .icon-container1::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;           /* линия прижата к левому краю */
    width: 26px;       /* длина линии */
    height: 1px;       /* толщина */
    background-color: rgb(0, 218, 0);
    border-radius: 1px;
}

    /* Modal Input Background for Target Coordinates */
#targetModal {
    padding: 13.3px;           /* 10px * 1.333 */
    border-radius: 6.7px;      /* 5px * 1.333 */
}

#alert-container {
    position: absolute;
    top: 13.3px;               /* 10px * 1.333 */
    left: 13.3px;              /* 10px * 1.333 */
    z-index: 1000;
}

#alert-menu {
    background: #d2d2d2;
    padding: 13.3px;           /* 10px * 1.333 */
    display: none; /* Изначально скрыто */
    border: none;
    width: 166.7px;            /* 125px * 1.333 */
    height: 735.3px;           /* 551.5px * 1.333 */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #000000;
    font-size: 9.3px;          /* 7px * 1.333 */
    transition: all 0.3s ease;
    position: absolute;
}

#alert-menu:hover {
    box-shadow: 0px 7.998px 26.66px rgba(0, 0, 0, 0.2); /* 6px*1.333, 20px*1.333 */
}

.leaflet-control-attribution {
    display: none !important;
}

#alert-menu h3 {
    margin: 0 0 6.7px;         /* 5px * 1.333 */
    text-align: center;
    font-size: 10.7px;         /* 8px * 1.333 */
    color: #c4c4c4;
}

#alert-menu div {
    margin-bottom: 3.3px;      /* 2.5px * 1.333 */
}

#alert-menu input[type=checkbox] {
    margin-right: 3.3px;       /* 2.5px * 1.333 */
}

button#alert-button {
    width: 22.7px;             /* 17px * 1.333 */
    height: 22.7px;            /* 17px * 1.333 */
    border-radius: 50%;
    background-color: #50785D;
    color: rgb(0, 0, 0);
    font-weight: bold;
    font-size: 8px;            /* 6px * 1.333 */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    border: none;
    cursor: pointer;
}


    .overlay {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 9999;
    width: 100%;
    height: 100%;
    background: rgba(255, 0, 0, 0.2);  /* Ярко-красный полупрозрачный фон для теста */
    background: url('kod.png') center/cover no-repeat;
    pointer-events: none; /* Позволяет кликам проходить сквозь */
    z-index: 2000; /* Поверх карты */
    opacity: 0.25; /* Сделать картинку менее прозрачной */
    transition: filter 0.3s ease; /* Плавный переход фильтра */
}
/* Кастомизация всплывающего окна */
.leaflet-popup-content {
    background-color: #f0f0f0;
    color: #333;
    padding: 13.3px;          /* 10*1.333 */
    border-radius: 13.3px;    /* 10*1.333 */
    font-family: 'Arial', sans-serif;
    font-size: 18.7px;        /* 14*1.333 */
}

.leaflet-popup-tip {
    background-color: #f0f0f0;
}

.leaflet-popup-content h3 {
    margin-top: 0;
    font-size: 21.3px;        /* 16*1.333 */
    color: #555;
}

.leaflet-control.ruler {
    position: absolute;
    right: 13.3px;            /* 10*1.333 */
    left: auto;
    top: auto;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Arial", sans-serif;
}

body {
    background: #f0f0f0;
}

/* Стили меню */
#passwordContainer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #252b36;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: white;
    text-align: center;
    z-index: 1010;
}

#passwordContainer img {
    width: 166.7px;           /* 125*1.333 */
    height: auto;
}

#loginInput, #passwordInput {
    padding: 13.3px 10px;     /* 10*1.333, 7.5*1.333 */
    font-size: 9.3px;         /* 7*1.333 */
    width: 266.7px;           /* 200*1.333 */
    height: 20px;             /* 15*1.333 */
    border: none;
    border-radius: 2.7px;     /* 2*1.333 */
    background-color: #3d4558;
    color: #fff;
    text-align: left;
    background-position: 10px center;  /* 7.5*1.333 */
    background-repeat: no-repeat;
    background-size: 16.7px;          /* 12.5*1.333 */
}

#loginInput::placeholder,
#passwordInput::placeholder {
    color: #b0b3b8;
}
.leaflet-popup-content-wrapper {
    zoom: 0.5; /* примерно 0.5 * (150/200) */
}

#submitButton {
    padding: 8px 26.7px;      /* 6*1.333, 20*1.333 */
    font-size: 9.3px;         /* 7*1.333 */
    background-color: #4674dc;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    border-radius: 0px;
}

#submitButton:hover {
    background-color: #5c90de;
}

#submitButton:active {
    background-color: #0033cc;
    transform: scale(0.98);
}

#menu-icon {
    position: absolute;
    top: 11.3px;              /* 8.5*1.333 */
    left: 13.3px;             /* 10*1.333 */
    width: 113.3px;           /* 85*1.333 */
    height: 16.7px;           /* 12.5*1.333 */
}

.inputWrapper {
    display: flex;
    flex-direction: column;
    gap: 6.7px;               /* 5*1.333 */
    margin-bottom: 136.3px;   /* 102.5*1.333 */
}

.custom-menu {
    position: absolute;
    bottom: 21.3px;           /* 16*1.333 */
    right: 13.3px;            /* 10*1.333 */
    display: flex;
    flex-direction: column;
    gap: 13.3px;              /* 10*1.333 */
    z-index: 1000;
}

.menu-row {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 4px;                 /* 3*1.333 */
    justify-content: flex-start;
}

.custom-button {
    width: 25.3px;            /* 19*1.333 */
    height: 20px;             /* 15*1.333 */
    background-color: rgb(101, 101, 101);
    border-radius: 2px;       /* 1.5*1.333 */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: default;
}

.custom-button img {
    width: 16.7px;            /* 12.5*1.333 */
    height: 16.7px;           /* 12.5*1.333 */
}

#left-arrow-button {
    width: 25.3px;            /* 19*1.333 */
    height: 20px;             /* 15*1.333 */
    background-color: rgb(101, 101, 101);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    border: none;
    cursor: pointer;
}

#left-arrow-button img {
    width: 14.7px;            /* 11*1.333 */
    height: 14.7px;           /* 11*1.333 */
}

#warning-message {
    position: fixed;
    top: 0;
    width: 100%;
    height: 16.7px;           /* 12.5*1.333 */
    background-color: rgba(0, 0, 0, 0.8);
    color: rgb(255, 0, 68);
    text-align: center;
    padding: 3.3px;           /* 2.5*1.333 */
    font-size: 9.3px;         /* 7*1.333 */
    z-index: 9999;
}

.menu-text {
    position: fixed;
    right: 13.3px;            /* 10*1.333 */
    bottom: 5.3px;            /* 4*1.333 */
    font-size: 10.7px;        /* 8*1.333 */
    color: rgba(0,0,0,0.3);
    line-height: 1;
    text-align: right;
    margin-bottom: 0;
    padding-top: 4px;         /* 3*1.333 */
}

    </style>
</head>
<body>
    <div id="warning-message">სამი საათის განმავლობაში არანაირი ინფორმაცია არ იყო</div>
    <div id="passwordContainer">    
        <img src="iconpas.png">
        <div class="inputWrapper">
            <input type="text" id="loginInput" placeholder="Логин">
            <input type="password" id="passwordInput" placeholder="Пароль">
            <button id="submitButton">Войти в систему</button>
        </div>
    </div>
    <div id="leaflet-control-layers"></div>
    </div>
    <div class="overlay"></div>
    <div id="map"></div>
<!-- Модальное окно для отображения координат -->
  <!-- Меню в правом нижнем углу -->
  <div class="custom-menu">
    <div class="menu-row">
            <div style="width: 66.1px;"></div>
      <div class="custom-button">
        <img src="reload.png" alt="Reload" />
      </div>
      <div class="custom-button">
        <img src="search.png" alt="Search" />
      </div>
    </div>
    <div class="menu-row">
      <div style="width: 95.5px;"></div>
      <div class="custom-button">
        <img src="signal.png" alt="Signal" />
      </div>
    </div>
    <div class="menu-row">
      <div style="width: 95.5px;"></div>
      <div class="custom-button">
        <img src="ugol.png" alt="Arrow" />
      </div>
    </div>
    <div class="menu-row">
      <div style="width: 95.5px;"></div>
      <div class="custom-button">
        <img src="pryamougol.png" alt="Layer" />
      </div>
    </div>
    <div class="menu-row">
      <div style="width: 95.5px;"></div>
      <div class="custom-button green">
        <img src="plus.png" alt="Plus" />
      </div>
    </div>
  <div class="menu-row">
    <div style="width: 40px;"></div>
    <!-- Новая кнопка со стрелкой -->
    <button id="left-arrow-button">
      <img src="strelka.png" alt="Arrow" />
    </button>
    <!-- Кнопка тревоги -->
    <button id="alert-button">0</button>
    <!-- Кнопка удаления -->
    <button id="deleteButton"><i class="fas fa-trash-alt"></i></button>
  </div>
      <!-- Полупрозрачный текст внутри меню -->
  <span class="menu-text">ver 1600 (1.6.0)</span>
</div>

  </div>

    <!-- Modal Elements -->
    <div class="modal-background" id="modalBackground"></div>
    <div class="modal" id="speedModal">
        <h2><i class="fas fa-tachometer-alt"></i> Введите скорость объекта (км/ч):</h2>
        <input type="text" id="speedInput" placeholder="Введите скорость" />
        <button class="modal-button" id="speedSubmit"><i class="fas fa-check"></i> Подтвердить</button>
        <button class="modal-button modal-close" id="speedClose"><i class="fas fa-times"></i> Закрыть</button>
    </div>
    <div class="modal-background" id="modalBackground"></div>
    <div class="modal" id="targetModal">
        <h2><i class="fas fa-map-marker-alt"></i> Введите цель (Координаты, например: 53.9,27.5667):</h2>
        <input type="text" id="targetInput" placeholder="Введите координаты" />
        <button class="modal-button" id="targetSubmit"><i class="fas fa-check"></i> Подтвердить</button>
        <button class="modal-button modal-close" id="targetClose"><i class="fas fa-times"></i> Закрыть</button>
    </div>
    <div id="alert-container">
  <div id="alert-menu">
    <h3>Дать тревогу</h3>
    <div><input type="checkbox" id="Сумська область"><label for="Сумська область">Сумская область</label></div>
    <div><input type="checkbox" id="г.Київ"><label for="г.Київ">г.Киев</label></div>
    <div><input type="checkbox" id="Харківська область"><label for="Харківська область">Харьковская область</label></div>
    <div><input type="checkbox" id="Чернігівська область"><label for="Чернігівська область">Черниговская область</label></div>
    <div><input type="checkbox" id="Полтавська область"><label for="Полтавська область">Полтавская область</label></div>
    <div><input type="checkbox" id="Дніпропетровська область"><label for="Дніпропетровська область">Днепропетровская область</label></div>
    <div><input type="checkbox" id="Київська область"><label for="Київська область">Киевская область</label></div>
    <div><input type="checkbox" id="Житомирська область"><label for="Житомирська область">Житомирская область</label></div>
    <div><input type="checkbox" id="Черкаська область"><label for="Черкаська область">Черкасская область</label></div>
    <div><input type="checkbox" id="Луганська область"><label for="Луганська область">Луганская область</label></div>
    <div><input type="checkbox" id="Донецька область"><label for="Донецька область">Донецкая область</label></div>
    <div><input type="checkbox" id="Кіровоградська область"><label for="Кіровоградська область">Кировоградская область</label></div>
    <div><input type="checkbox" id="Вінницька область"><label for="Вінницька область">Винницкая область</label></div>
    <div><input type="checkbox" id="Чернівецька область"><label for="Чернівецька область">Черновицкая область</label></div>
    <div><input type="checkbox" id="Херсонська область"><label for="Херсонська область">Херсонская область</label></div>
    <div><input type="checkbox" id="АР Крим"><label for="АР Крим">АР Крым</label></div>
    <div><input type="checkbox" id="Одеська область"><label for="Одеська область">Одесская область</label></div>
    <div><input type="checkbox" id="Миколаївська область"><label for="Миколаївська область">Николаевская область</label></div>
    <div><input type="checkbox" id="Хмельницька область"><label for="Хмельницька область">Хмельницкая область</label></div>
    <div><input type="checkbox" id="Рівненська область"><label for="Рівненська область">Ровненская область</label></div>
    <div><input type="checkbox" id="Тернопільська область"><label for="Тернопільська область">Тернопольская область</label></div>
    <div><input type="checkbox" id="Івано-Франківська область"><label for="Івано-Франківська область">Ивано-Франковская область</label></div>
    <div><input type="checkbox" id="Закарпатська область"><label for="Закарпатська область">Закарпатская область</label></div>
    <div><input type="checkbox" id="Волинська область"><label for="Волинська область">Волынская область</label></div>
    <div><input type="checkbox" id="Львівська область"><label for="Львівська область">Львовская область</label></div>
    <div><input type="checkbox" id="Запорізька область"><label for="Запорізька область">Запорожская область</label></div>
    <div><input type="checkbox" id="По всей территории"><label for="По всей территории">По всей территории</label></div>
  </div>
</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.1.0/leaflet-measure.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch/dist/bundle.min.js"></script>
    <script
    src="https://cdn.jsdelivr.net/gh/gokertanrisever/leaflet-ruler@master/src/leaflet-ruler.js"
    integrity="sha384-8SqKZR7V8uOetpjjbcNJHvwuHpb074WS0UXjCLhzfJUqYn3B/uWx1WVv5mwRp1mV"
    crossorigin="anonymous"
></script>
    <script>
            const correctLogin = "admin";  // Указываем правильный логин
    const correctPassword = "12339321";  // Указываем правильный пароль

    document.getElementById("submitButton").addEventListener("click", function() {
        let userLogin = document.getElementById("loginInput").value;
        let userPassword = document.getElementById("passwordInput").value;
        
        if (userLogin === correctLogin && userPassword === correctPassword) {
            document.getElementById("passwordContainer").style.display = "none"; // Прячем форму
            document.getElementById("map").style.display = "block"; // Показываем карту
            initMap(); // Загружаем карту
        } else {
            alert("Неверный логин или пароль!");
        }
    });
        const map = L.map('map', {
            zoomControl: false,

        }).setView([41.987647682705955, 44.0001426214923], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);
        
        
// Обычный OSM (без фильтра)
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
});

// OSM с CSS-фильтром (например, черно-белым)
const osmGrayLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    className: 'map-tiles', // Класс, на который будет действовать фильтр
    attribution: '© OpenStreetMap contributors'
});


// Черная OSM-карта (CartoDB Dark Matter)
const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '© <a href="https://carto.com/">CARTO</a>'
});

// Спутниковая карта с границами (Esri World Imagery with Labels)
const satelliteLayerWithBorders = L.layerGroup([
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }),
    L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Boundaries and labels © Esri'
        
    })
    
]);
var Stadia_AlidadeSmoothDark = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.{ext}', {
	minZoom: 0,
	maxZoom: 20,
	attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
	ext: 'png'
});

const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
        
});

googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
});

googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
});
var OpenTopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
	maxZoom: 17,
	attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
});

var OPNVKarte = L.tileLayer('https://tileserver.memomaps.de/tilegen/{z}/{x}/{y}.png', {
	maxZoom: 18,
	attribution: 'Map <a href="https://memomaps.de/">memomaps.de</a> <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
});
var Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
});
var Stadia_OSMBright = L.tileLayer('https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.{ext}', {
	minZoom: 0,
	maxZoom: 20,
	attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
	ext: 'png'
});

// Добавляем стандартную карту по умолчанию
googleStreets.addTo(map);

// Настройка слоев для переключения
const baseLayers = {
    "OSM": osmLayer,
    "OSM Gray": osmGrayLayer,
    "OSM Black": darkLayer,
    "Satellite": satelliteLayerWithBorders,
    "Google Maps": googleStreets,
    "Google Hybrid": googleHybrid,
    "Google Terrain": googleTerrain,
    "OpenTopoMap": OpenTopoMap,
    "OPNVKarte": OPNVKarte,
    "Ersi": Esri_WorldTopoMap,
    "Stadia White": Stadia_OSMBright,
    "Stadia Dark": Stadia_AlidadeSmoothDark
};

// Добавляем контрол для переключения карт
L.control.layers(baseLayers).addTo(map);
map.on('baselayerchange', function (e) {
    const mapContainer = document.querySelector('.leaflet-container');

    if (e.name === 'OSM Gray' || e.name === 'Google Terrain') {
        mapContainer.classList.add('dark-map');
    } else {
        mapContainer.classList.remove('dark-map');
    }
});

// Функция для изменения фильтра на изображении
function updateOverlayFilter() {
    const overlay = document.querySelector('.overlay');
    if (map.hasLayer(darkLayer)) {
        overlay.style.filter = 'invert(1) brightness(2)';
    } else {
        overlay.style.filter = 'none';
    }
}

// При добавлении или удалении слоя темной карты
map.on('layeradd', updateOverlayFilter);
map.on('layerremove', updateOverlayFilter);

// Если карта уже загружена, сразу применим фильтр
updateOverlayFilter();

        let currentObjectId = 9500;
        let deleteMode = false;
        const markers = [];

        function calculateCourse(lat1, lng1, lat2, lng2) {
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;

            return Math.atan2(
                Math.sin(dLng) * Math.cos(lat2Rad),
                Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng)
            );
        }

        function calculateNewPosition(lat, lng, speed, time, targetLat, targetLng) {
            const distance = (speed / 3600) * time;
            const earthRadius = 6371;
            const bearing = calculateCourse(lat, lng, targetLat, targetLng);

            const latRadians = (lat * Math.PI) / 180;
            const lngRadians = (lng * Math.PI) / 180;

            const newLatRadians = Math.asin(
                Math.sin(latRadians) * Math.cos(distance / earthRadius) + 
                Math.cos(latRadians) * Math.sin(distance / earthRadius) * Math.cos(bearing)
            );

            const newLngRadians =
                lngRadians +
                Math.atan2(
                    Math.sin(bearing) * Math.sin(distance / earthRadius) * Math.cos(latRadians),
                    Math.cos(distance / earthRadius) - Math.sin(latRadians) * Math.sin(newLatRadians)
                );

            return [
                (newLatRadians * 180) / Math.PI,
                (newLngRadians * 180) / Math.PI
            ];
        }
        

        function haversine(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = ((lat2 - lat1) * Math.PI) / 180;
            const dLng = ((lng2 - lng1) * Math.PI) / 180;

            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos((lat1 * Math.PI) / 180) *
                Math.cos((lat2 * Math.PI) / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function generateId() {
            return currentObjectId++;
        }

        // Show modal and handle speed input
        function showSpeedModal(callback) {
            const modal = document.getElementById('speedModal');
            const modalBackground = document.getElementById('modalBackground');
            const speedInput = document.getElementById('speedInput');
            const submitButton = document.getElementById('speedSubmit');
            const closeButton = document.getElementById('speedClose');
            
            modal.classList.add('show');
            modalBackground.style.display = 'none';

            submitButton.onclick = () => {
                const speed = parseFloat(speedInput.value);
                if (!isNaN(speed)) {
                    callback(speed);
                    closeModal();
                } else {
                    alert('Некорректная скорость!');
                }
            };

            closeButton.onclick = closeModal;

            function closeModal() {
                modal.classList.remove('show');
                modalBackground.style.display = 'none';
                closeModal = ""
            }

            modal.classList.add('show');
            modalBackground.style.display = 'none';
        }

        // Show modal and handle target input
        function showTargetModal(callback) {
            const modal = document.getElementById('targetModal');
            const modalBackground = document.getElementById('modalBackground');
            const targetInput = document.getElementById('targetInput');
            const submitButton = document.getElementById('targetSubmit');
            const closeButton = document.getElementById('targetClose');
            
            modal.classList.add('show');
            modalBackground.style.display = 'block';

            submitButton.onclick = () => {
                const [targetLat, targetLng] = targetInput.value.split(',').map(coord => parseFloat(coord));
                if (!isNaN(targetLat) && !isNaN(targetLng)) {
                    callback(targetLat, targetLng);
                    closeModal();
                } else {
                    alert('Некорректные координаты цели!');
                }
            };

            closeButton.onclick = closeModal;

            function closeModal() {
                modal.classList.remove('show');
                modalBackground.style.display = 'none';
            }
        }

        map.on('click', (e) => {
            if (deleteMode) return;

            const { lat, lng } = e.latlng;

            // Get speed input via modal
            showSpeedModal((speed) => {
                // Get target input via modal
                showTargetModal((targetLat, targetLng) => {

                     const objectId = generateId();
            let iconUrl;
let iconClass = "red-id";
let shiftedClass = "";
let shiftedClasss = "";

            if (speed === 0) { 
                
    // Если скорость 0, сразу устанавливаем иконку EPVO
    iconUrl = 'EPVO.png'; 
    iconClass = 'blue-id';  

    // Генерируем ID от 500000 и время по Минску
    const objectId1 = getNextObjectId(); 
    const kievTime = getKievTime();

    // Меняем iconHtml ПОЛНОСТЬЮ
    iconHtml = `
  <div class="icon-container1 ${iconClass}">
            <img src="${iconUrl}" class="icon" />
            <div class="info-container1 ${shiftedClass} ${shiftedClasss}">
            </div>
                        </div>
        </div>
  `;
                icon = L.divIcon({
        className: 'icon',
        html: iconHtml,
        iconSize: [6.5, 6.5], // общий размер
        iconAnchor: [10, 8],
    });
} else {

// Условия выбора иконки по скорости
if (speed >= 120 && speed <= 121) {
    iconUrl = 'supercam.png';

} else if (speed > 120 && speed <= 200) {

    // случай иконки — создаём случай 1 раз
    const random = Math.random();
    iconUrl = random < 0.3 ? 'neyst tip.png' : 'shahed.png';

} else if (speed >= 7559 && speed < 7560) {
    iconUrl = 'iskander.png';
    shiftedClass = 'shifted-info-container';

} else if (speed >= 950 && speed <= 951) {
    iconUrl = 'kalibr.png';
    shiftedClass = 'shifted-info-container';
    } else if (speed >= 1000 && speed <= 1001) {
        iconUrl = 'x101.png';
        shiftedClass = 'shifted-info-container';
    } else if (speed >= 450 && speed <= 459) {
        iconUrl = 'kab.png';
    } else if (speed >= 11024 && speed <= 11025) {
        shiftedClass = 'shifted-info-container';
        iconUrl = 'Tsirkon.png';
    } else if (speed >= 14687 && speed <= 14688) {
        shiftedClass = 'shifted-info-container';
        iconUrl = 'Kinzhal.png';
    } else if (speed >= 4899 && speed <= 4900) {
        iconUrl = 'Kh-22.png';
    } else if (speed >= 1049 && speed <= 1050) {
        iconUrl = 'Kh-59.png';
    } else if (speed >= 80 && speed <= 85) {
        iconUrl = 'parodia.png';
    } else if (speed >= 290 && speed <= 291) {
        iconUrl = 'Lancet.png';
    } else if (speed >= 98 && speed <= 99) {
        iconUrl = 'gerbera.png';
    } else if (speed >= 118 && speed <= 119) {
        iconUrl = 'ZZala.png';
    } else if (speed >= 4500 && speed <= 4501) {
        iconUrl = 'grumble.png';
        shiftedClass = 'shifted-info-container';
    } else if (speed >= 1030 && speed <= 1031) {
        shiftedClass = 'shifted-info-container';
        iconUrl = 'kh-69.png';
    } else if (speed >= 109 && speed <= 110) {
        iconUrl = 'orlan.png';
    } else if (speed >= 5400 && speed <= 5401) {
        iconUrl = 'atacms.png';
        shiftedClass = 'shifted-info-container';
        iconClass = 'blue-id'; // Синий ID для ATACMS
        lineColor = '#006aff';  // Set blue line color for blue objects
    } else if (speed >= 959 && speed <= 960) {
        iconUrl = 'storm-shadow.png';
        shiftedClass = 'shifted-info-container';
        iconClass = 'zl';
        lineColor = '#006aff';  // Set blue line color for blue objects
    } else if (speed >= 190 && speed <= 191) {
        iconUrl = 'lutiy.png';
        iconClass = 'zl';
        lineColor = '#006aff';  // Set blue line color for blue objects
    } else if (speed >= 201 && speed <= 202) {
        iconUrl = 'beaver.png';
        iconClass = 'zl';
        lineColor = '#006aff';  // Set blue line color for blue objects
    } else if (speed >= 329 && speed <= 330) {
        iconUrl = 'rys`.png';
        iconClass = 'zl';
        lineColor = '#006aff';  // Set blue line color for blue objects
    } else if (speed >= 74 && speed <= 75) {
        iconUrl = 'Molnia.png';
    } else if (speed >= 3000 && speed <= 3001) {
        iconUrl = 'gmlrs.png';
        shiftedClass = 'shifted-info-container';
        iconClass = 'blue-id';
    } else if (speed >= 900 && speed <= 901) {
        iconUrl = 'iskanderk.png';
        shiftedClass = 'shifted-info-container';
    } else if (speed >= 2519 && speed <= 2520) {
        iconUrl = 'kh31.png';
        shiftedClass = 'shifted-info-container';
    } else if (speed >= 1100 && speed <= 1101) {
        iconUrl = 'su-24.png';
    } else if (speed >= 1102 && speed <= 1103) {
        iconUrl = 'su-24 BLR.png';
        iconClass = 'blue-id';
    } else if (speed >= 1002 && speed <= 1003) {
        iconUrl = 'f-16.png';
        iconClass = 'blue-id';
    } else if (speed >= 800 && speed <= 801) {
        iconUrl = 'Su-34.png';
        iconClass = 'red-id su34-icon';
    } else if (speed >= 815 && speed <= 816) {
        iconUrl = 'Su-57.png';
    } else if (speed >= 820 && speed <= 821) {
        iconUrl = 'Su-30.png';
    } else if (speed >= 1202 && speed <= 1203) {
        iconUrl = 'Su-30 BLR.png';
        iconClass = 'blue-id';  
    } else if (speed >= 840 && speed <= 840) {
        iconUrl = 'Su-35.png';
    } else if (speed >= 2300 && speed <= 2301) {
        iconUrl = 'Tu-22M3.png';
    } else if (speed >= 952 && speed <= 953) {
         iconUrl = 'Su25.png';
    } else if (speed >= 954 && speed <= 955) {
        iconUrl = 'Su25 BLR.png';
        iconClass = 'blue-id';  
    } else if (speed >= 850 && speed <= 851) {
        iconUrl = 'mig-29 BLR.png';
        iconClass = 'blue-id';  
    } else if (speed >= 961 && speed <= 962) {
         iconUrl = 'kh-35.png';
         shiftedClass = 'shifted-info-container';
    } else if (speed >= 3180 && speed <= 3181) {
        iconUrl = 'oniks.png';
        shiftedClass = 'shifted-info-container';
    } else if (speed >= 500 && speed <= 501) {
        iconUrl = 'shahed 238.png';
    } else if (speed >= 920 && speed <= 921) {
        iconUrl = 'mig-31.png';
    } else if (speed >= 800 && speed <= 801) {
        iconUrl = 'a-50.png';
    } else if (speed >= 880 && speed <= 881) {
        iconUrl = 'litak.png';
        iconClass = 'litak-id'; 
    } else if (speed >= 1110 && speed <= 1111) {
        iconUrl = 'mirage.png';
        iconClass = 'blue-id';  
    } else if (speed >= 300 && speed <= 301) {
        iconUrl = 'bplaper.png';
            iconClass = 'perexop';  
    } else if (speed >= 205 && speed <= 250) {
        iconUrl = 'vertolet.png';
        iconClass = 'vertolet';  
    } else {
        // Если скорость не попала ни в одно условие, ставим "neyst tip.png"
        iconUrl = 'neyst tip.png';
    }
      const objectId2 = getNextObjectIdBlue();
    if (!window._markerIconMemory) window._markerIconMemory = {};
    const key = `${lat}-${lng}-${speed}`;

    if (!window._markerIconMemory[key]) {
        window._markerIconMemory[key] = iconUrl;  // сохраняем один раз
    }

    iconUrl = window._markerIconMemory[key];       // используем сохранённый тип
    // -----------------------------------------

    
    if (iconUrl === 'litak.png') {
        const objectId3 = getNextLitakId();
        iconHtml = `
    <div class="icon-container ${iconClass}">
            <div class="icon-wrap">
        <img src="${iconUrl}" class="icon" />
                        <div class="info-container ${shiftedClass} ${shiftedClasss}" style="opacity:0;">    
                    <span class="label-container ${iconClass}">${objectId3}</span>
                    <span class="r-container ${iconClass}">ЛБ·</span>
                </div>
            </div>
        `;
                icon = L.divIcon({
            className: 'icon',
            html: iconHtml,
            iconSize: [26, 26],
            iconAnchor: [13, 13],
        });
    } else if (iconClass === 'kr') {
        iconUrl = 'kalibr.png';
        iconClass = 'red-id';
        iconHtml = `
    <div class="icon-container ${iconClass}">
            <div class="icon-wrap">
        <img src="${iconUrl}" class="icon" />
          <div class="info-container ${shiftedClass} ${shiftedClasss}" style="opacity:0;">
                    <span class="label-container ${iconClass}">${objectId}р</span>
                    <span class="r-container ${iconClass}">ПП·</span>
                </div>
            </div>
        `;
        icon = L.divIcon({
            className: 'icon',
            html: iconHtml,
            iconSize: [26, 26],
            iconAnchor: [13, 13],
        });
    } else if (iconClass === 'zl') {
        const objectId2 = getNextObjectIdBlue();
        iconUrl = 'zl.png';
        iconHtml = `
    <div class="icon-container ${iconClass}">
            <div class="icon-wrap">
        <img src="${iconUrl}" class="icon" />
        <div class="info-container ${shiftedClass} ${shiftedClasss}" style="opacity:0;">
                    <span class="label-container ${iconClass}">0${objectId2}р</span>
                    <span class="r-container ${iconClass}">ЗЛ·</span>
                </div>
            </div>
        `;
        icon = L.divIcon({
            className: 'icon',
            html: iconHtml,
            iconSize: [26, 26],
            iconAnchor: [13, 13],
        });
    } else if (iconClass === 'blue-id') {
        iconUrl = 'blue.png';
        iconHtml = `
    <div class="icon-container ${iconClass}">
            <div class="icon-wrap">
        <img src="${iconUrl}" class="icon" />
        <div class="info-container ${shiftedClass} ${shiftedClasss}" style="opacity:0;">
                    <span class="label-container ${iconClass}">0${objectId2}р</span>
                    <span class="r-container ${iconClass}">СВ·</span>
                </div>
            </div>
        `;
        icon = L.divIcon({
            className: 'icon',
            html: iconHtml,
            iconSize: [26, 26],
            iconAnchor: [13, 13],
        });
    } else if (iconClass === 'vertolet') {
        iconClass = 'blue-id';
        iconHtml = `
    <div class="icon-container ${iconClass}">
            <div class="icon-wrap">
        <img src="${iconUrl}" class="icon" />
        <div class="info-container ${shiftedClass} ${shiftedClasss}" style="opacity:0;">
                    <span class="label-container ${iconClass}">0${objectId2}р</span>
                    <span class="r-container ${iconClass}">СВ·</span>
                </div>
            </div>
        `;
        icon = L.divIcon({
            className: 'icon',
            html: iconHtml,
            iconSize: [26, 26],
            iconAnchor: [13, 13],
        });
    } else if (iconClass === 'perexop') {
        iconHtml = `
    <div class="icon-container ${iconClass}">
            <div class="icon-wrap">
        <img src="${iconUrl}" class="icon" />
        <div class="info-container ${shiftedClass} ${shiftedClasss}" style="opacity:0;">
                    <span class="label-container ${iconClass}">0${objectId2}р</span>
                    <span class="r-container ${iconClass}">ЗЛ·</span>
                </div>
            </div>
        `;
        icon = L.divIcon({
            className: 'icon',
            html: iconHtml,
            iconSize: [28.8, 28.8],
            iconAnchor: [14.4, 14.4],
        });
    } else {
        const iconTypes = {
            "shahed 238.png": "Ударний дрон",
            "shahed.png": "Ударний дрон",
            "кр.png": "Крилата ракета"
        };

        const iconName = iconTypes[iconUrl] || "Невідомий об'єкт";
        const randomNumber = Math.floor(Math.random() * 200) + 1;
iconHtml = `
    <div class="icon-container ${iconClass}">
            <div class="icon-wrap">
        <img src="${iconUrl}" class="icon" />
        <div class="info-container ${shiftedClass} ${shiftedClasss}" style="opacity:0;">
            <span class="label-container ${iconClass}">${objectId}р</span>
            <span class="r-container ${iconClass}">ПП·</span>
        </div>
    </div>
`;

        icon = L.divIcon({
            className: 'icon',
            html: iconHtml,
            iconSize: [26, 26],
            iconAnchor: [13, 13],
        });
    }
}
let iconCreated = false;
function addSpeedCircle(marker, speed) {
    let color = null;

    if (speed > 4000) {
        color = "#ff6a00";
    } else if (speed >= 2000) {
        color = "#ffea70";
    } else {
        return null;
    }

    const latlng = marker.getLatLng();
    const circle = L.circleMarker(latlng, {
        radius: 14.94,
        stroke: false,
        fillColor: color,
        fillOpacity: 0.65,
    }).addTo(map);

    marker.on("move", () => {
        circle.setLatLng(marker.getLatLng());
    });

    return circle;
}

const marker = L.marker([lat, lng], { icon }).addTo(map);

// если у маркера уже был круг — удаляем
if (marker._speedCircle) {
    map.removeLayer(marker._speedCircle);
}

marker._speedCircle = addSpeedCircle(marker, speed);


setInterval(() => {
    const el = document.getElementById('warning-message');
    
    // бросаем "монетку": 0 или 1
    const show = Math.random() < 0.5;

    if (show) {
        el.classList.remove('hidden'); // показать
    } else {
        el.classList.add('hidden');    // спрятать
    }
}, 10 * 60 * 1000); // каждые 10 минут
const translations = {
    "supercam": "Supercam",
    "shahed": "Shahed",
    "iskander": "Искандер-М",
    "kalibr": "Калибр",
    "x101": "Х-101",
    "kab": "КАБ",
    "Tsirkon": "Циркон",
    "Kinzhal": "Кинжал",
    "Kh-22": "Х-22",
    "Kh-59": "Х-59",
    "parodia": "Пародия",
    "Lancet": "Ланцет",
    "gerbera": "Гербера",
    "ZZala": "Зала",
    "grumble": "ЗУР",
    "kh-69": "Х-69",
    "orlan": "Орлан",
    "atacms": "ATACMS",
    "storm-shadow": "Storm Shadow",
    "lutiy": "Лютый",
    "beaver": "Бобёр",
    "rys`": "Рысь",
    "Molnia": "Молния",
    "gmlrs": "GMLRS",
    "iskanderk": "Искандер-К",
    "kh31": "Х-31",
    "su-24": "Су-24",
    "f-16": "F-16",
    "Su-34": "Су-34",
    "Su-57": "Су-57",
    "su-30": "Су-30",
    "Su-30 BLR": "Су-30 (Беларусь)",
    "Su-35": "Су-35",
    "Tu-22M3": "Ту-22М3",
    "mirage": "Mirage-2000",
    "neyst tip": "Неизвестный тип"
};

let objectKey = iconUrl.replace('.png', '').replace(/-/g, ' ');
let objectType = translations[objectKey] || objectKey;
objectType = objectType.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');


let currentLat = lat;
let currentLng = lng;
let targetLatVar = targetLat;
let targetLngVar = targetLng;
let isActive = true;
let waypoints = [];
let currentWaypointIndex = 0;
let lastTimestamp = null;

/// ==== Переменные для следа ====
let showTrail = false;
let trailCoords = [[currentLat, currentLng]];

let trailLine = null;
let startMarker = null;
let trailDecorator = null;

// ==== Цвет линии ====
function getLineColor(marker) {
    if (!marker || !marker.options || !marker.options.icon) return '#F70300';
    const html = marker.options.icon.options.html || '';
    if (html.includes('shahed')) return '#FDCF00';
    if (html.includes('neyst tip')) return '#006aff';
    return '#F70300';
}

// ==== Создание линии и стрелок ====
function createTrail(marker) {
    const lineColor = getLineColor(marker);
    trailLine = L.polyline(trailCoords, { color: lineColor, weight: 0.7, opacity: 1 }).addTo(map);
    startMarker = L.circleMarker(trailCoords[0], {
        radius: 0.2, color: lineColor, fillColor: lineColor, fillOpacity: 1
    }).addTo(map);
    updateDecorator(lineColor);
}

// ==== Декоратор стрелок ====
function updateDecorator(lineColor) {
    if (trailDecorator) map.removeLayer(trailDecorator);
    trailDecorator = L.polylineDecorator(trailLine, {
        patterns: [{
            offset: '100%',
            repeat: 0,
            symbol: L.Symbol.arrowHead({
                pixelSize: 4,
                polygon: true,
                pathOptions: { color: lineColor, fillOpacity: 1 }
            })
        }]
    }).addTo(map);
}

// ==== Кнопка включения следа ====
function initTrailButton(marker) {
    const btn = document.getElementById("left-arrow-button");
    if (!btn) return console.warn("Кнопка #left-arrow-button не найдена!");
    btn.addEventListener("click", () => {
        showTrail = !showTrail;
        if (showTrail) createTrail(marker);
        else {
            if (trailLine) { map.removeLayer(trailLine); trailLine = null; }
            if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
            if (trailDecorator) { map.removeLayer(trailDecorator); trailDecorator = null; }
        }
    });
}

if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => initTrailButton(marker));
} else {
    initTrailButton(marker);
}

// ==== Верхнее меню ====
function createTopMenu(marker) {
    if (typeof deleteMode !== 'undefined' && deleteMode) return;
    if (document.getElementById('top-menu-' + objectId)) return;

    const menu = document.createElement('div');
    menu.id = 'top-menu-' + objectId;

  const existingMenus = document.querySelectorAll('[id^="top-menu-"]').length;
// отступ для новой панели (уменьшил зазор)
const offset = 15 + existingMenus * 30;

Object.assign(menu.style, {
    position: 'fixed',
    top: offset + 'px',
    left: '0',
    width: '100%',
    height: '30px',
    background: 'rgba(0, 0, 0, 0.4)',
    color: '#fff',
    fontFamily: 'Consolas, monospace',
    fontSize: '13px',
    zIndex: '9999',
    borderBottom: '1px solid rgba(255,255,255,0.15)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    padding: '0 8px',
    boxShadow: 'none',
    transition: 'none'
});

// === Текст ===
const row = document.createElement('div');
Object.assign(row.style, {
    display: 'grid',
    gridTemplateColumns: 'repeat(6, 1fr)',
    alignItems: 'center',
    width: 'calc(100% - 120px)',
    textAlign: 'center',
    letterSpacing: '0.3px',
    columnGap: '12px',
    paddingRight: '120px'
});

row.innerHTML = `
    <div>${objectId}р</div>
    <div>A0</div>
    <div>D0</div>
    <div>H0.0</div>
    <div>V${speed}</div>
    <div>1</div>
`;

// === Кнопки ===
const icons = document.createElement('div');
Object.assign(icons.style, {
    position: 'absolute',
    right: '8px',
    display: 'flex',
    gap: '12px'
});

icons.innerHTML = `
    <button id="changeCoordsBtn-${objectId}" title="Изменить маршрут" style="
        width:22px;height:22px;
        border:1px solid rgba(255,255,255,0.25);
        background: rgb(101, 101, 101);
        border-radius:2px;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:0;
    ">
        <img src="reload.png" alt="reload" style="width:14px;height:14px;">
    </button>

    <button id="zelenySamBtn-${objectId}" title="Самолёт" style="
        width:22px;height:22px;
        border:1px solid rgba(255,255,255,0.25);
        background: rgb(101, 101, 101);
        border-radius:2px;
        cursor:default;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:0;
    ">
        <img src="zelenysam.png" alt="plane" style="width:15px;height:15px;">
    </button>

    <button id="closeTopMenu-${objectId}" title="Закрыть" style="
        width:22px;height:22px;
        border:1px solid rgba(255,255,255,0.25);
        background: rgb(101, 101, 101);
        border-radius:2px;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:0;
        font-size:12px;
        color:#222;
    ">
        <i class="fas fa-trash-alt"></i>
    </button>
`;

    menu.appendChild(row);
    menu.appendChild(icons);
    document.body.appendChild(menu);

    // обновлено — линия теперь исчезает при закрытии меню
    document.getElementById(`closeTopMenu-${objectId}`).onclick = () => {
        // вернуть иконку в обычный вид, если была раскрыта
if (marker._expanded) {
    marker.setIcon(L.divIcon({
        className: "icon",
        html: marker._originalIconHtml,
        iconSize: marker._originalSize,
        iconAnchor: marker._originalAnchor
    }));
    marker._expanded = false;
}

        menu.remove();
    // если есть линия направления — удалить
    if (headingLine) {
        map.removeLayer(headingLine);
        headingLine = null;
    }

    // 🔥 если иконка была изменена — вернуть исходную
    if (marker.isExpanded) {
        marker.setIcon(L.divIcon({
            className: 'icon',
            html: iconHtml,
            iconSize: [28.8, 28.8],
            iconAnchor: [14.4, 14.4],
        }));
        marker.isExpanded = false;
    }

    // обновить позиции остальных меню
    const allMenus = document.querySelectorAll('[id^="top-menu-"]');
    allMenus.forEach((m, i) => {
        m.style.top = 15 + i * 30 + 'px';
    });
};


    document.getElementById(`changeCoordsBtn-${objectId}`).onclick = () => {
        openCoordsModal((coordsText) => {
            if (!coordsText) return;
            const coordsList = coordsText
                .split("\n")
                .map(line => line.split(",").map(Number))
                .filter(c => !isNaN(c[0]) && !isNaN(c[1]));
            if (coordsList.length > 0) {
                const pos = marker.getLatLng();
                currentLat = pos.lat;
                currentLng = pos.lng;
                waypoints = [[currentLat, currentLng], ...coordsList];
                currentWaypointIndex = 1;
                targetLatVar = waypoints[1][0];
                targetLngVar = waypoints[1][1];
                lastTimestamp = null;
                if (!isActive) {
                    isActive = true;
                    scheduleNextFrame(updatePosition);
                }
            }
        });
    };
}

// ==== Клик по маркеру ====
// Добавляем функционал линии направления
let headingLine = null;

marker.on('click', () => {
    createTopMenu(marker);

    // сохранить исходные параметры 1 раз
if (!marker._saved) {

    // HTML который реально стоит у маркера
    const iconHtmlThis = marker.options.icon.options.html;

    // Сохраняем оригинальный HTML
    marker._originalIconHtml = iconHtmlThis;

    // Сохраняем размер и якорь
    marker._originalAnchor = marker.options.icon.options.iconAnchor;
    marker._originalSize   = marker.options.icon.options.iconSize;

    // Разбор HTML
    const temp = document.createElement("div");
    temp.innerHTML = iconHtmlThis;

    const idEl = temp.querySelector(".label-container");
    const rEl  = temp.querySelector(".r-container");

    marker._originalID = idEl ? idEl.textContent.trim() : "";
    marker._originalR  = rEl  ? rEl.textContent.trim() : "";
marker._originalRLS = getRlsForObject(objectId, iconUrl);

    marker._saved = true; // чтобы не сохранять снова
}

const ICON_TYPES = {
    "shahed.png": "Ударный дрон",
    "kalibr.png": "Крылатая ракета",
    "Su-35.png": "Су-35",
    "Su-34.png": "Су-34",
    "Su-30.png": "Су-30",
    "Su-57.png": "Су-57",
    "orlan.png": "Развед. дрон",
    "bplaper.png": "БпЛА перехват.",
    "vertolet.png": "Вертолет",
    "mig-31.png": "МиГ-31",
    "gerbera.png": "Гербера",
};
const objectType = ICON_TYPES[iconUrl] || "";

    // ==== Разворачиваем ====
    if (!marker._expanded) {

        const angle = marker._lastAngle || 0;

       const expandedHtml = `
<div class="icon-container ${iconClass} ${marker._expanded ? "expanded" : ""} ${objectType ? "with-type" : ""}">

    <!-- БЛОК ИКОНКИ — ТОЛЬКО КАРТИНКА -->
    <div class="icon-wrap">
        <img src="${iconUrl}" class="icon" />
    </div>

    <!-- ТЕКСТ — ОТДЕЛЬНО -->
    <div class="info-container"
         style="
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-start !important;
            justify-content: flex-start !important;

            padding: 0.8px 4px 0.8px 8px !important;
            min-width: auto !important;
    height: auto !important;
    gap: 0.8px !important;                    /* 1 * 0.83 */
    line-height: 0.9 !important;
    contain: none !important;
             ">
<span class="r-container ${iconClass}">${objectType}</span>
            <div style="display:flex; gap:2px;">
                <span class="label-container ${iconClass}">${marker._originalID}</span>
                <span class="r-container ${iconClass}">${marker._originalR}</span>
            </div>

            <span class="r-container ${iconClass}">${speed}</span>

            <span class="r-container ${iconClass}">${Math.round(angle)}°</span>

<span class="r-container ${iconClass}">${marker._originalRLS}</span>


        </div>
    </div>
`;


const expandedAnchor = [
    marker._originalAnchor[0],
    marker._originalAnchor[1] + (objectType ? 9.5 : 5.5)
];


        marker.setIcon(L.divIcon({
            className: "icon",
            html: expandedHtml,
            iconSize: marker._originalSize,
            iconAnchor: expandedAnchor
        }));

        marker._expanded = true;
    }

    // ==== Сворачиваем обратно ====
    else {

        marker.setIcon(L.divIcon({
            className: "icon",
            html: marker._originalIconHtml,
            iconSize: marker._originalSize,
            iconAnchor: marker._originalAnchor
        }));

        marker._expanded = false;
    }

    if (headingLine) {
        map.removeLayer(headingLine);
        headingLine = null;
        return;
    }

    headingLine = L.polyline([], {
        color: '#999999', // серая
        weight: 0.8,      // тоньше
        opacity: 0.9
    }).addTo(map);
});

// ==== Функция обновления линии направления ====
function updateHeadingLine(angleDeg) {
    if (!headingLine) return;
    const pos = marker.getLatLng();
    const angleRad = angleDeg * Math.PI / 180;
    const lengthMeters = 2000000; // 1000 км
    const R = 6371000;

    const lat2 = pos.lat + (lengthMeters / R) * (180 / Math.PI) * Math.cos(angleRad);
    const lng2 = pos.lng + (lengthMeters / R) * (180 / Math.PI) * Math.sin(angleRad) / Math.cos(pos.lat * Math.PI / 180);

    headingLine.setLatLngs([[pos.lat, pos.lng], [lat2, lng2]]);
}

// ==== Вращение и движение ====
function rotateIcon(lat1, lng1, lat2, lng2, speed) {
    if (speed === 0) {
        marker._icon.querySelector('.icon').style.transform = `rotate(0deg)`;
        return;
    }
    const course = calculateCourse(lat1, lng1, lat2, lng2) * (180 / Math.PI);
    const angle = (course + 360) % 360;
    marker._icon.querySelector('.icon').style.transform = `rotate(${angle}deg)`;
    updateHeadingLine(angle);

    // 🔥 ОБЯЗАТЕЛЬНО — чтобы курс обновлялся в expandedHtml
    marker._lastAngle = angle;
}   

markers.push(marker);

function scheduleNextFrame(callback) {
    if (document.hasFocus()) requestAnimationFrame(callback);
    else setTimeout(() => { if (isActive) callback(performance.now()); }, 1000);
}

function updatePosition(timestamp) {
    if (!lastTimestamp) lastTimestamp = timestamp;
    const deltaTime = (timestamp - lastTimestamp) / 1000;
    lastTimestamp = timestamp;

    const speedMps = speed * 1000 / 3600;
    let [newLat, newLng] = calculateNewPosition(currentLat, currentLng, speedMps, deltaTime, targetLatVar, targetLngVar);

    const distance = haversine(currentLat, currentLng, targetLatVar, targetLngVar);
    const stepDistance = haversine(currentLat, currentLng, newLat, newLng);

if (stepDistance >= distance || distance <= 0.00001) {
    currentLat = targetLatVar;
    currentLng = targetLngVar;
    currentWaypointIndex++;

    if (currentWaypointIndex < waypoints.length) {
        targetLatVar = waypoints[currentWaypointIndex][0];
        targetLngVar = waypoints[currentWaypointIndex][1];
        scheduleNextFrame(updatePosition);
    } else {
        isActive = false;

        // Удаляем круг
        if (marker._speedCircle) {
            map.removeLayer(marker._speedCircle);
        }

        // Удаляем маркер
        marker.remove();

        if (headingLine)
            map.removeLayer(headingLine);
    }
}
 else {
        currentLat = newLat;
        currentLng = newLng;
        rotateIcon(currentLat, currentLng, targetLatVar, targetLngVar, speed);
        marker.setLatLng([currentLat, currentLng]);
        scheduleNextFrame(updatePosition);
    }

    trailCoords.push([currentLat, currentLng]);
    if (showTrail && trailLine) {
        trailLine.setLatLngs(trailCoords);
        updateDecorator();
    }
}

// ==== Инициализация маршрута ====
waypoints.push([targetLat, targetLng]);
currentWaypointIndex = 0;
lastTimestamp = null;
scheduleNextFrame(updatePosition);

// ==== Вспомогательные ====
function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)**2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function calculateCourse(lat1, lon1, lat2, lon2) {
    const toRad = x => x * Math.PI / 180;
    const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.cos(toRad(lon2 - lon1));
    return Math.atan2(y, x);
}

function calculateNewPosition(lat1, lon1, speedMps, deltaTime, lat2, lon2) {
    const distanceToTravel = speedMps * deltaTime;
    const distanceTotal = haversine(lat1, lon1, lat2, lon2);
    if (distanceToTravel >= distanceTotal) return [lat2, lon2];
    const fraction = distanceToTravel / distanceTotal;
    return [
        lat1 + (lat2 - lat1) * fraction,
        lon1 + (lon2 - lon1) * fraction
    ];
}

// ==== Модалка координат ====
function openCoordsModal(callback) {
    const background = document.createElement('div');
    background.className = 'modal-background show';
    document.body.appendChild(background);

    const box = document.createElement('div');
    box.className = 'modal show coords-modal-top-left';
    box.innerHTML = `
        <h2>Выберите точки маршрута</h2>
        <textarea id="coordsInput" placeholder="Кликай колёсиком по карте"
            style="width:100%;height:80px;font-size:7px;background:#1e232c;color:#fff;
            border:1px solid #3a4152;border-radius:4px;padding:3px;"></textarea>
        <button id="coordsOk" class="modal-button">OK</button>
        <button id="coordsCancel" class="modal-button">Отмена</button>
    `;
    document.body.appendChild(box);
    box.style.top = '20px';
    box.style.left = '20px';
    box.style.transform = 'none';

    let isDragging = false, offsetX, offsetY;
    box.onmousedown = (e) => {
        if (e.target.tagName === "TEXTAREA" || e.target.tagName === "BUTTON") return;
        isDragging = true;
        offsetX = e.clientX - box.offsetLeft;
        offsetY = e.clientY - box.offsetTop;
        document.onmousemove = (ev) => {
            if (isDragging) {
                box.style.left = ev.clientX - offsetX + "px";
                box.style.top = ev.clientY - offsetY + "px";
            }
        };
        document.onmouseup = () => {
            isDragging = false;
            document.onmousemove = null;
            document.onmouseup = null;
        };
    };

    const textarea = box.querySelector('#coordsInput');
    let tempWaypoints = [marker.getLatLng()];
    let routeLine = L.polyline(tempWaypoints, { color: '#dd0347', weight: 1, opacity: 1 }).addTo(map);

    const addCoord = (e) => {
        if (e.originalEvent.button !== 1) return;
        e.originalEvent.preventDefault();
        const latlng = map.mouseEventToLatLng(e.originalEvent);
        textarea.value += latlng.lat.toFixed(5) + "," + latlng.lng.toFixed(5) + "\n";
        tempWaypoints.push(latlng);
        routeLine.setLatLngs(tempWaypoints);
    };

    map.on('mousedown', addCoord);

    box.querySelector('#coordsOk').onclick = () => {
        map.off('mousedown', addCoord);
        map.removeLayer(routeLine);
        const coordsText = textarea.value.trim();
        callback(coordsText);
        document.body.removeChild(box);
        document.body.removeChild(background);
    };

    box.querySelector('#coordsCancel').onclick = () => {
        map.off('mousedown', addCoord);
        map.removeLayer(routeLine);
        document.body.removeChild(box);
        document.body.removeChild(background);
        callback(null);
    };
}

// ==== Удаление маркера без удаления линии ====
// ==== Клик по маркеру ====
// ==== Клик по маркеру ====
marker.on('click', function (e) {
    // если активен deleteMode — только удаляем, без меню
    if (deleteMode) {
        e.originalEvent.stopPropagation(); // блокируем всплытие
        e.originalEvent.preventDefault();  // предотвращаем другие действия
    // 🟡 Удаляем круг
    if (marker._speedCircle) {
        map.removeLayer(marker._speedCircle);
    }
        if (confirm('Удалить этот объект?')) {
            marker.remove();
            isActive = false;
            const deleteButton = document.getElementById('deleteButton');
            if (deleteButton) {
                deleteMode = false;
                deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
            }
        }

        return; // <<< прекращаем выполнение, меню не откроется
    }

    // если не deleteMode — показываем меню
    createTopMenu(marker);

},)},)},)},)
// ==== Кнопка deleteMode ====
document.getElementById('deleteButton').onclick = function () {
    deleteMode = !deleteMode;
    this.innerHTML = deleteMode ? '<i class="fas fa-check"></i>' : '<i class="fas fa-trash-alt"></i>';
};

        window.addEventListener('beforeunload', (event) => {
            event.preventDefault();
            event.returnValue = '';
        });
// РЛС для объектов
const rlsOptions = [
    "79К6",
    "35Д6М",
    "Малахіт",
    "Малахіт", // Увеличиваем вероятность "Малахіт"
    "Малахіт",
    "П-37", // Увеличиваем вероятность "Малахіт"
    "П-18МА",
    "П-19МА", // Увеличиваем вероятность "Малахіт"
    "5Н84А"
];

// Функция для выбора РЛС
function getRlsForObject(objectId, iconUrl) {
    // Для всех объектов (включая спецобъекты) выбираем случайную РЛС
    const randomIndex = Math.floor(Math.random() * rlsOptions.length);
    return rlsOptions[randomIndex];
}

let touchTimer;

map.on('contextmenu', function (e) {
    const coords = `${e.latlng.lat}, ${e.latlng.lng}`;
    navigator.clipboard.writeText(coords).then(() => {
        alert(`Координаты скопированы: ${coords}`);
    }).catch(err => {
        console.error('Ошибка копирования координат:', err);
    });
});

map.on('touchstart', function (e) {
    // Запускаем таймер, чтобы определить долгий клик
    touchTimer = setTimeout(() => {
        const latlng = e.latlng;
        const coords = `${latlng.lat}, ${latlng.lng}`;

        navigator.clipboard.writeText(coords).then(() => {
            alert(`Координаты скопированы: ${coords}`);
        }).catch(err => {
            console.error('Ошибка копирования координат:', err);
        });
    }, 800); // Время задержки в миллисекундах (800 мс = долгий клик)

});

map.on('touchend', function (e) {
    // Если палец поднят до завершения задержки, отменяем таймер
    clearTimeout(touchTimer);
});

fetch("front.json")
  .then(response => response.json())
  .then(data => {
    L.geoJSON(data, {
      style: function(feature) {
        let color = '#bdbdbd'; // По умолчанию цвет "неизвестно"
        let opacity = 1.5; // По умолчанию непрозрачность для "неизвестно"
        let fillOpacity = 1; // По умолчанию заливка непрозрачная

        if (feature.properties.name === 'Багатокутник 4') {
          color = '#000000'
          opacity = 1; // Прозрачность границы
          fillOpacity = 0.0; // Прозрачность заливки
        }

        // Возвращаем стиль с прозрачностью
        return {
          color: color,
          weight: 1.8,
          opacity: opacity,
          fillColor: color,
          fillOpacity: fillOpacity
        };
      }
    }).addTo(map);
  })
  .catch(error => console.error("Ошибка загрузки JSON:", error));

let polygons = {}; // активные районы
let activeDistricts = {}; // какие районы включены
let menuVisible = false;

fetch('districts.geojson')
  .then(response => response.json())
  .then(geojsonData => {
    const districtsByRegion = {};
    geojsonData.features.forEach(feature => {
      const region = feature.properties.ADMIN_1;
      if (!districtsByRegion[region]) districtsByRegion[region] = [];
      districtsByRegion[region].push(feature);
    });
// === ВСЕГДА подсвечиваем ЛУГАНСКУЮ ОБЛАСТЬ через trevoga.json ===
fetch('trevoga.json')
  .then(r => r.json())
  .then(trevogaData => {

    trevogaData.features.forEach(feature => {

      // Ищем "Луганская область" в любых свойствах
      const props = feature.properties;
      const isLugansk = Object.values(props).some(v => 
        typeof v === 'string' && v.trim().toLowerCase() === 'луганская область'
      );

      if (isLugansk) {

        const layer = L.geoJSON(feature, {
          style: {
            color: 'red',
            fillColor: 'red',
            fillOpacity: 0.13,
            weight: 0.3
          }
        }).addTo(map);

        const districtName =
          props.ADMIN_2 ||
          props.name ||
          props.region ||
          'Луганская область';

        polygons[districtName] = layer;
        activeDistricts[districtName] = true;
      }
    });
  });


    document.querySelectorAll('#alert-menu input[type=checkbox]').forEach(checkbox => {
      const region = checkbox.id;

      checkbox.addEventListener('click', async function (e) {
        e.preventDefault(); // блокируем установку галочки

        // ======== ОТДЕЛЬНО ОБРАБАТЫВАЕМ г.Київ ========
        if (region === 'г.Київ') {
          if (polygons['Kyiv']) {
            // если уже включён — выключаем
            map.removeLayer(polygons['Kyiv']);
            delete polygons['Kyiv'];
            checkbox.checked = false;
            return;
          }

          // загружаем Kyiv.json
          const kyivData = await fetch('Kyiv.json').then(r => r.json());
          const kyivLayer = L.geoJSON(kyivData, {
            style: {
  color: 'red',
  fillColor: 'red',
  fillOpacity: 0.13,
  weight: 0.3
}

          }).addTo(map);

          polygons['Kyiv'] = kyivLayer;
          checkbox.checked = true;
          return; // не открываем список
        }
        // ==============================================

        const existingList = checkbox.parentElement.querySelector('.district-list');
        if (existingList) {
          existingList.remove();
          return;
        }

        if (districtsByRegion[region]) {
          const subList = document.createElement('div');
          subList.className = 'district-list';
          subList.style.marginLeft = '20px';
          subList.style.marginTop = '5px';

          districtsByRegion[region].forEach(feature => {
            const districtName = feature.properties.ADMIN_2;

            const div = document.createElement('div');
            div.innerHTML = `
              <input type="checkbox" id="${districtName}" data-region="${region}">
              <label for="${districtName}">${districtName}</label>
            `;
            subList.appendChild(div);

            const districtCheckbox = div.querySelector('input');

            if (activeDistricts[districtName]) {
              districtCheckbox.checked = true;
            }

            districtCheckbox.onchange = function() {
              const featureData = districtsByRegion[region].find(f => f.properties.ADMIN_2 === districtName);

              if (districtCheckbox.checked) {
                const layer = L.geoJSON(featureData, {
                  style: {
                    color: 'red',
                    fillColor: 'red',
                    fillOpacity: 0.13,
                    weight: 0.15
                  }
                }).addTo(map);

                polygons[districtName] = layer;
                activeDistricts[districtName] = true;
              } else {
                if (polygons[districtName]) {
                  map.removeLayer(polygons[districtName]);
                  delete polygons[districtName];
                }
                delete activeDistricts[districtName];
              }
            };
          });

          checkbox.parentElement.appendChild(subList);
        }
      });
    });
  });

// кнопка "Дать тревогу"
document.getElementById('alert-button').onclick = function() {
  menuVisible = !menuVisible;
  document.getElementById('alert-menu').style.display = menuVisible ? 'block' : 'none';
};

        function getKievTime() {
    const options = {
        timeZone: 'Europe/Kiev',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false // 24-часовой формат
    };
    return new Intl.DateTimeFormat('ru-RU', options).format(new Date());
}

let objectIdCounter = 44000;

function getNextObjectId() {
    return objectIdCounter++;


    const iconHTML = `
        <div class="icon-container ${iconClass}">
            <img src="${iconUrl}" class="icon" />
            <div class="info-container ${shiftedClass}">
                <span class="label-container ${iconClass}">${objectId} ${minskTime}</span>
                <span class="rl-container ${iconClass}">ЕПВО</span>
            </div>
        </div>
    `;
    return iconHTML;
}
let objectIdCounterBlue = '0750';

function getNextObjectIdBlue() {
  return objectIdCounterBlue++;
}
let counterLitakId = 9900;
function getNextLitakId() {
    return counterLitakId++;
}
    function updateAlertCount() {
      const bodyText = document.body.innerText || document.body.textContent;
      const matches = bodyText.match(/(ПП|СВ|ЛБ|ЗЛ)/gi);
      const count = matches ? matches.length : 0;
      document.getElementById('alert-button').textContent = count;
    }

    // Проверяем каждые 500 мс
    setInterval(updateAlertCount, 500);
    updateAlertCount();
     // Загрузка GeoJSON файла
    // Загружаем ОККУПИРОВАННЫЕ территории
    // Загружаем ЛИНИЮ фронта
fetch('line.json')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, {
      style: {
        color: 'red',
        weight: 1.5
      }
    }).addTo(map);
  });

fetch('okkyp.json')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, {
      style: {
        stroke: false,        // 🔥 отключает контур
        fillColor: '#e6a57a',
        fillOpacity: 0.3      // прозрачность, подбери
      }
    }).addTo(map);
  });

    </script>
</body>
</html>